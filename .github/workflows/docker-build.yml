name: 🔧 JetBrains Proxy CI

on:
  push:
    branches: [main]
  pull_request:

jobs:
  build-proxy:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: proxy

    steps:
      - name: 🧾 Checkout repository
        uses: actions/checkout@v4

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 🐳 Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 📦 Install dependencies
        run: pip install PyYAML

      - name: 🔍 Run one-shot verifier
        id: verify
        run: |
          set -e
          python3 scripts/verify-build-ready.py 2>error.log
          echo "msg<<EOF" >> $GITHUB_OUTPUT
          cat error.log >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: 💬 Post comment on PR (if verifier fails)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request?.user?.login || "contributor"
            const message = `🔴 **Build verification failed** for @${author}

            \`\`\`
            ${{ steps.verify.outputs.msg }}
            \`\`\`

            🛠 **Possible causes**
            - \`config.yaml\` is missing or misplaced
            - The file doesn’t contain a valid \`tokens\` array with a \`jwt\`
            - Dockerfile may be missing \`COPY config.yaml\`

            💡 Tip: run \`make verify\` locally before pushing. Let us know if you need help. 💙`
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            })

      - name: 🧪 Validate Makefile indentation
        run: make check-tabs

      - name: 🛠️ Build Docker image
        if: success()
        run: make build

      - name: 🔍 Check config.example.yaml format
        run: |
          cp config.example.yaml config.yaml
          make check-config

  proxy-test:
    runs-on: ubuntu-latest
    needs: build-proxy
    services:
      proxy:
        image: jetbrains-proxy
        ports:
          - 8080:8080

    steps:
      - name: ⏳ Wait for proxy startup
        run: |
          echo "Waiting for proxy on port 8080..."
          for i in {1..10}; do
            nc -z localhost 8080 && break || sleep 2
          done

      - name: 🚦 Test proxy endpoint
        run: |
          curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q 200 && echo "✅ Proxy is responsive." || (echo "❌ Proxy did not start." && exit 1)

